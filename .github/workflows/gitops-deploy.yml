name: Homelab GitOps Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/argocd-apps/**'
      - 'apps/k8s-apps/**'
      - '.github/workflows/gitops-deploy.yml'
  workflow_dispatch:

jobs:
  gitops:
    name: Deploy ArgoCD + App-of-Apps + ApplicationSet
    runs-on: self-hosted

    env:
      ARGOCD_NAMESPACE: argocd
      ARGOCD_CHART_VERSION: 7.7.10
      GIT_REPO_URL: git@github.com:cterence/homelab-gitops.git
      KUBECONFIG: ${{ github.workspace }}/kubeconfig

    steps:
      # 1Ô∏è‚É£ Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Load SSH Private Key (for repo access)
      - name: Load SSH Private Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 3Ô∏è‚É£ Configure SSH Known Hosts (to trust GitHub)
      - name: Configure SSH Known Hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      # 4Ô∏è‚É£ Write kubeconfig from GitHub secret
      - name: Configure kubeconfig
        run: |
          echo "${{ secrets.K3S_KUBECONFIG }}" > $KUBECONFIG
          chmod 600 $KUBECONFIG
          echo "‚úÖ Wrote kubeconfig to $KUBECONFIG"

      # 5Ô∏è‚É£ Verify cluster access
      - name: Verify Kubernetes connection
        run: |
          echo "üîç Checking K3S cluster connectivity..."
          kubectl cluster-info
          kubectl get nodes -o wide

      # 6Ô∏è‚É£ Ensure ArgoCD namespace exists
      - name: Ensure ArgoCD namespace exists
        run: |
          kubectl get ns $ARGOCD_NAMESPACE || kubectl create ns $ARGOCD_NAMESPACE

      # üßπ 7Ô∏è‚É£ Cleanup old ArgoCD resources (prevents Helm ownership errors)
      - name: Cleanup previous ArgoCD installation
        run: |
          echo "üßπ Cleaning up any old ArgoCD resources..."
          kubectl delete namespace argocd --ignore-not-found=true
          kubectl delete crd applications.argoproj.io appprojects.argoproj.io \
            applicationsets.argoproj.io argocdexports.argoproj.io --ignore-not-found=true
          kubectl delete clusterrole argocd-application-controller argocd-server argocd-dex-server --ignore-not-found=true
          kubectl delete clusterrolebinding argocd-application-controller argocd-server argocd-dex-server --ignore-not-found=true
          echo "‚úÖ Cleanup completed."
          kubectl create ns $ARGOCD_NAMESPACE || true

      # 8Ô∏è‚É£ Install or upgrade ArgoCD via Helm
      - name: Install or upgrade ArgoCD
        run: |
          helm repo add argo https://argoproj.github.io/argo-helm || true
          helm repo update
          helm upgrade --install argocd argo/argo-cd \
            --namespace $ARGOCD_NAMESPACE \
            --version $ARGOCD_CHART_VERSION \
            --set installCRDs=true \
            --set server.service.type=LoadBalancer \
            --set configs.params."server.insecure"=true

      # 9Ô∏è‚É£ Wait for ArgoCD server
      - name: Wait for ArgoCD server to be ready
        run: |
          echo "‚è≥ Waiting for ArgoCD server..."
          kubectl -n $ARGOCD_NAMESPACE wait \
            --for=condition=available deployment/argocd-server --timeout=600s

      # üîü Apply both ArgoCD app manifests (App-of-Apps + ApplicationSet)
      - name: Apply App-of-Apps and ApplicationSet
        run: |
          echo "üöÄ Applying ArgoCD bootstrap manifests..."
          kubectl apply -f apps/argocd-apps/app-of-apps.yaml
          kubectl apply -f apps/argocd-apps/applicationset.yaml
          echo "‚úÖ Both app-of-apps.yaml and applicationset.yaml applied."

      # 11Ô∏è‚É£ Verify that ArgoCD registered the Application
      - name: Verify App-of-Apps registration
        run: |
          echo "üîç Checking ArgoCD Application..."
          kubectl -n $ARGOCD_NAMESPACE get app app-of-apps || echo "App-of-Apps not yet created."

      # 12Ô∏è‚É£ Force ArgoCD to refresh/sync
      - name: Force sync all ArgoCD Applications
        run: |
          echo "üîÑ Forcing ArgoCD refresh..."
          kubectl -n $ARGOCD_NAMESPACE get applications.argoproj.io -o name | \
          xargs -I{} kubectl -n $ARGOCD_NAMESPACE patch {} --type merge \
            -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}'
          echo "‚úÖ ArgoCD Applications refreshed and syncing."

      # 13Ô∏è‚É£ Show ArgoCD admin password
      - name: Display ArgoCD Admin Password
        run: |
          echo "üîë ArgoCD Admin Password:"
          kubectl -n $ARGOCD_NAMESPACE get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d
