name: Homelab GitOps Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/argocd-apps/**'
      - 'apps/k8s-apps/**'
      - '.github/workflows/gitops-deploy.yml'
  workflow_dispatch:

jobs:
  gitops:
    name: Deploy ArgoCD + Sync All Apps
    runs-on: self-hosted   # your self-hosted runner inside homelab

    env:
      ARGOCD_NAMESPACE: argocd
      ARGOCD_CHART_VERSION: 7.7.10
      GIT_REPO_URL: git@github.com:cterence/homelab-gitops.git
      KUBECONFIG: ${{ github.workspace }}/kubeconfig

    steps:
      # 1Ô∏è‚É£ Checkout your repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Load SSH Private Key (for private repo access)
      - name: Load SSH Private Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 3Ô∏è‚É£ Configure SSH Known Hosts (trust GitHub)
      - name: Configure SSH Known Hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      # 4Ô∏è‚É£ Write kubeconfig from GitHub secret
      - name: Write kubeconfig from secret
        run: |
          echo "${{ secrets.K3S_KUBECONFIG }}" > $KUBECONFIG
          chmod 600 $KUBECONFIG
          echo "‚úÖ Wrote kubeconfig to $KUBECONFIG"

      # 5Ô∏è‚É£ Verify connection to K3S cluster
      - name: Verify Kubernetes connection
        run: |
          echo "üîç Checking K3S cluster connection..."
          kubectl cluster-info
          kubectl get nodes -o wide

      # 6Ô∏è‚É£ Ensure ArgoCD namespace exists
      - name: Ensure ArgoCD namespace exists
        run: |
          kubectl get ns $ARGOCD_NAMESPACE || kubectl create ns $ARGOCD_NAMESPACE

      # üßπ 7Ô∏è‚É£ Cleanup any previous ArgoCD installation (fixes Helm ownership issues)
      - name: Cleanup old ArgoCD resources (first-time setup fix)
        run: |
          echo "üßπ Cleaning up any old ArgoCD installation..."
          kubectl delete namespace argocd --ignore-not-found=true
          kubectl delete crd applications.argoproj.io appprojects.argoproj.io \
            applicationsets.argoproj.io argocdexports.argoproj.io --ignore-not-found=true
          kubectl delete clusterrole argocd-application-controller argocd-server argocd-dex-server --ignore-not-found=true
          kubectl delete clusterrolebinding argocd-application-controller argocd-server argocd-dex-server --ignore-not-found=true
          echo "‚úÖ Cleanup completed. Proceeding with Helm installation..."
          kubectl create ns $ARGOCD_NAMESPACE || true

      # 8Ô∏è‚É£ Install or upgrade ArgoCD using Helm
      - name: Install or upgrade ArgoCD
        run: |
          helm repo add argo https://argoproj.github.io/argo-helm || true
          helm repo update
          helm upgrade --install argocd argo/argo-cd \
            --namespace $ARGOCD_NAMESPACE \
            --version $ARGOCD_CHART_VERSION \
            --set installCRDs=true \
            --set server.service.type=LoadBalancer \
            --set configs.params."server.insecure"=true

      # 9Ô∏è‚É£ Wait until ArgoCD server is available
      - name: Wait for ArgoCD server
        run: |
          echo "‚è≥ Waiting for ArgoCD server deployment to be ready..."
          kubectl -n $ARGOCD_NAMESPACE wait \
            --for=condition=available deployment/argocd-server --timeout=600s

      # üîü Apply App-of-Apps manifest
      - name: Apply App-of-Apps manifest
        run: |
          echo "üöÄ Applying App-of-Apps configuration..."
          kubectl apply -f apps/argocd-apps/app-of-apps.yaml

      # 11Ô∏è‚É£ Verify App-of-Apps registration
      - name: Verify App-of-Apps registration
        run: |
          echo "üîç Checking ArgoCD Application..."
          kubectl -n $ARGOCD_NAMESPACE get app app-of-apps || echo "App-of-Apps not yet created."

      # 12Ô∏è‚É£ Force refresh and sync for all ArgoCD applications
      - name: Force ArgoCD sync
        run: |
          echo "üîÑ Forcing ArgoCD to refresh and sync all applications..."
          kubectl -n $ARGOCD_NAMESPACE get applications.argoproj.io -o name | \
          xargs -I{} kubectl -n $ARGOCD_NAMESPACE patch {} --type merge \
            -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}'
          echo "‚úÖ All ArgoCD applications refreshed and syncing with latest Git state."

      # 13Ô∏è‚É£ Display ArgoCD Admin Password for login
      - name: Display ArgoCD Admin Password
        run: |
          echo "üîë ArgoCD Admin Password:"
          kubectl -n $ARGOCD_NAMESPACE get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d
