name: ðŸš€ Bootstrap ArgoCD GitOps

on:
  # Manual trigger button in GitHub Actions UI
  workflow_dispatch:

  # Automatic trigger when ArgoCD configuration changes
  push:
    branches: [main]
    paths:
      - 'argocd-apps/**'
      - '.github/workflows/gitops-deploy.yml'

jobs:
  bootstrap:
    runs-on: self-hosted

    steps:
      - name: ðŸ§© Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.K3S_KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: ðŸ§  Install ArgoCD
        run: |
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo update
          helm upgrade --install argocd argo/argo-cd \
            --namespace argocd --create-namespace \
            --set server.service.type=LoadBalancer

      
      # ðŸ‘‡ Add these two steps (App-of-Apps + ApplicationSet)
      - name: ðŸš€ Apply ArgoCD Root App (App-of-Apps)
        run: |
          echo "ðŸ“¦ Applying ArgoCD Root Application..."
          kubectl apply -f argocd-apps/app-of-apps.yaml

      - name: ðŸ§© Apply ArgoCD ApplicationSet
        run: |
          echo "ðŸ“¦ Applying ArgoCD ApplicationSet..."
          kubectl apply -f argocd-apps/applicationset.yaml

      - name: âœ… Verify ArgoCD Applications
        run: |
          kubectl get applications.argoproj.io -n argocd || true
