name: Homelab GitOps Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/argocd-apps/**'
      - 'apps/k8s-apps/**'
      - '.github/workflows/gitops-deploy.yml'
  workflow_dispatch:

jobs:
  gitops:
    name: Deploy ArgoCD + Sync All Apps
    runs-on: self-hosted           # Your self-hosted runner

    env:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml  # Adjust if your kubeconfig is elsewhere
      ARGOCD_NAMESPACE: argocd
      ARGOCD_CHART_VERSION: 7.7.10
      GIT_REPO_URL: git@github.com:cterence/homelab-gitops.git

    steps:
      # 1Ô∏è‚É£ Checkout your repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Load SSH key (for private Git repo access)
      - name: Load SSH Private Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 3Ô∏è‚É£ Configure known_hosts for GitHub (avoids host authenticity prompt)
      - name: Configure SSH Known Hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      # 4Ô∏è‚É£ Verify K3S cluster connectivity
      - name: Verify Kubernetes Connection
        run: |
          echo "üîç Checking Kubernetes context..."
          kubectl cluster-info
          kubectl get nodes -o wide

      # 5Ô∏è‚É£ Ensure ArgoCD namespace exists
      - name: Create ArgoCD namespace if missing
        run: |
          kubectl get ns $ARGOCD_NAMESPACE || kubectl create ns $ARGOCD_NAMESPACE

      # 6Ô∏è‚É£ Install or upgrade ArgoCD using Helm
      - name: Install or upgrade ArgoCD
        run: |
          helm repo add argo https://argoproj.github.io/argo-helm || true
          helm repo update
          helm upgrade --install argocd argo/argo-cd \
            --namespace $ARGOCD_NAMESPACE \
            --version $ARGOCD_CHART_VERSION \
            --set server.service.type=LoadBalancer \
            --set configs.params."server.insecure"=true

      # 7Ô∏è‚É£ Wait for ArgoCD server deployment to become available
      - name: Wait for ArgoCD server to be ready
        run: |
          echo "‚è≥ Waiting for ArgoCD server..."
          kubectl -n $ARGOCD_NAMESPACE wait \
            --for=condition=available deployment/argocd-server --timeout=600s

      # 8Ô∏è‚É£ Apply the App-of-Apps manifest
      - name: Apply App-of-Apps manifest
        run: |
          echo "üöÄ Bootstrapping ArgoCD from Git..."
          kubectl apply -f apps/argocd-apps/app-of-apps.yaml

      # 9Ô∏è‚É£ Verify that ArgoCD registered the App-of-Apps
      - name: Verify App-of-Apps registration
        run: |
          echo "üîç Checking for ArgoCD Application..."
          kubectl -n $ARGOCD_NAMESPACE get app app-of-apps || echo "App-of-Apps not yet created."

      # üîÅ 10Ô∏è‚É£ Force refresh and sync all ArgoCD Applications
      - name: Force sync all ArgoCD Applications
        run: |
          echo "üîÑ Triggering ArgoCD refresh..."
          kubectl -n $ARGOCD_NAMESPACE get applications.argoproj.io -o name | \
          xargs -I{} kubectl -n $ARGOCD_NAMESPACE patch {} --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}'
          echo "‚úÖ All ArgoCD apps refreshed and syncing with latest Git state."

      # üîê 11Ô∏è‚É£ Display ArgoCD admin password
      - name: Display ArgoCD Admin Password
        run: |
          echo "üîë ArgoCD Admin Password:"
          kubectl -n $ARGOCD_NAMESPACE get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d
